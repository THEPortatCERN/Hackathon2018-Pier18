<html>
  <head>
    <meta charset="utf-8">
    <title>Visualization</title>
    <link rel="stylesheet" href="scatter.css" charset="utf-8">
    <!--<script src="http://d3js.org/d3.v4.min.js" charset="utf-8"></script>-->
    <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <!-- <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script> -->
    <script src="d3-tip/d3-tip.js" charset="utf-8"></script>
  </head>
  <script type="text/javascript">

  </script>
  <body>
    <div id="scatter"></div>

    <script>

      // TODO: First list all the documents in the database
      // TODO: Select one of them to get the duplication analysis
      // TODO: Add support for more parameters in solr
      // TODO: normalization
      // TODO: zoom
      // TODO: show human readable date
      // TODO: add normal
      const query = "The negative impacts of the El Nino induced drought, the worst in 35 years,\nwhich has caused a humanitarian crisis affecting 39 million people or 13% of\nSADC population, continues to intensify. Several factors including depleted\nfood reserves, rising food prices, lower commodity prices, slowing economic\ngrowth among other key factors, are exacerbating the situation. Staple food\nprices are rising due to the generally poor crop production over the past two\nyears. The Regional cereal deficit currently stands at close to 7.4 metric\ntonnes and is 11% below the five year average dropping from 29 million tonnes\nin 2015 to 26 million tonnes in 2016 (figures exclude Mauritius and\nSeychelles). The majority of the population is now entirely dependent on the\nmarkets for food.\n\n **Highlights**\n\n  * The negative impacts of the El Nino induced drought that has caused a";

      //const url = 'file:///home/ben/projects/DEEPER/deep-redundancy/visualization/output.json';
      const url = 'http://128.141.118.30:8983/solr/deep/select?fl=title,publisher,published_date,id,score';

      fetch(url, {
        method: 'POST',
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify({ query, limit: 300 }),
      })
        .then(res => res.json())
        .then((json) => {
          const data = json.response.docs.filter(datum => datum['published_date'] !== 'None')
            .map(datum => ({
              ...datum,
              size: 3,
              published_date: new Date(datum.published_date),
              publisher: datum.publisher || 'N/A',
            }))

          var margin = { top: 50, right: 300, bottom: 50, left: 50 },
            outerWidth = 1420,
            outerHeight = 680,
            width = outerWidth - margin.left - margin.right,
            height = outerHeight - margin.top - margin.bottom;

          var xCat = "published_date",
            yCat = "score",
            colorCat = "publisher",
            rCat = 'size';

          const maxX = Math.max(...data.map(datum => datum[xCat]));
          const minX = Math.min(...data.map(datum => datum[xCat]));

          const maxY = Math.max(...data.map(datum => datum[yCat]));
          const minY = Math.min(...data.map(datum => datum[yCat]));

          var xMax = maxX+1,
            xMin = minX,
            yMax = maxY+10,
            yMin = minY

          var x = d3.scaleTime().domain([xMin, xMax])
            .range([0, width]).nice();

          var y = d3.scaleLinear().domain([yMin, yMax])
            .range([height, 0]).nice();

          var xAxis = d3.axisBottom(x);
          var yAxis = d3.axisLeft(y);

          var color = d3.scaleOrdinal(d3.schemeCategory10);

          var tip = d3.tip()
            .attr("class", "d3-tip")
            .offset([-10, 0])
            .html(function(d) {
              return "Days ago" + ": " + d[xCat] + "<br>" + "Similarity" + ": " + d[yCat] +"%" +"<br>" + "Organization" + ": " + d[colorCat] +"<br>" + "Confidence" + ": " + d[rCat] +"%";
            });

          var zoomBeh = d3.zoom().on("zoom", function () {
              var new_xScale = d3.event.transform.rescaleX(x)
              var new_yScale = d3.event.transform.rescaleY(y)

              // update axes
              svg.select(".x.axis").call(xAxis.scale(new_xScale));
              svg.select(".y.axis").call(yAxis.scale(new_yScale));

              markers.attr("transform", d3.event.transform);
            });

          var svg = d3.select("#scatter")
            .append("svg")
            .attr("width", outerWidth)
            .attr("height", outerHeight)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(zoomBeh);

          svg.call(tip);

          svg.append("rect")
            .attr("width", width)
            .attr("height", height);

          svg.append("g")
            .classed("x axis", true)
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .append("text")
            //.classed("label", true)
            //.attr("x", width)
            //.attr("y", margin.bottom - 10)
            // .style("text-anchor", "end")
            .text("Time");

          svg.append("g")
            .classed("y axis", true)
            .call(yAxis)
            .append("text")
            .classed("label", true)
            .attr("transform", "rotate(-90)")
            .attr("y", -margin.left)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Similarity");

          var objects = svg.append("svg")
            .classed("objects", true)
            .attr("width", width)
            .attr("height", height);

          objects.append("svg:line")
            .classed("axisLine hAxisLine", true)
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", width)
            .attr("y2", 0)
            .attr("transform", "translate(0," + height + ")");

          objects.append("svg:line")
            .classed("axisLine vAxisLine", true)
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", 0)
            .attr("y2", height);

          var markers = objects.selectAll(".dot")
            .data(data)
            .enter().append("circle")
            .classed("dot", true)
            .attr("r", function (d) { return 6 * Math.sqrt(d[rCat] / Math.PI); })
            .attr("cx", function (d) { return x(d[xCat]); })
            .attr("cy", function (d) { return y(d[yCat]); })
            .style("fill", function(d) { return color(d[colorCat]); })
            .on("mouseover", tip.show)
            .on("mouseout", tip.hide);

          var legend = svg.selectAll(".legend")
            .data(color.domain())
            .enter().append("g")
            .classed("legend", true)
            .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

          legend.append("circle")
            .attr("r", 3.5)
            .attr("cx", width + 20)
            .attr("fill", color);

          legend.append("text")
            .attr("x", width + 26)
            .attr("dy", ".35em")
            .text(function(d) { return d; });

        })
        .catch(res => console.warn(res));
    </script>
  </body>
</html>
